--[[
    PROJECT: RESPAWN (v4.5 - TITAN EDITION)
    Architecture: Monolithic Modular
    Style: High Contrast Black/Silver + Lucide Icons
    
    CREDITS:
    - UI Framework: Custom "Respawn" Core
    - Icons: Lucide (Auto-fetched via HTTP)
]]

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local Respawn = {}
Respawn.__index = Respawn

--// 1.0 INTERNAL SIGNAL CLASS
local Signal = {}
Signal.__index = Signal
function Signal.new() return setmetatable({_listeners = {}}, Signal) end
function Signal:Connect(callback)
    local listener = {callback = callback, disconnected = false}
    table.insert(self._listeners, listener)
    return { Disconnect = function() listener.disconnected = true listener.callback = nil end }
end
function Signal:Fire(...)
    for _, listener in ipairs(self._listeners) do
        if not listener.disconnected then task.spawn(listener.callback, ...) end
    end
end

--// 2.0 CONFIGURATION & THEME
local Config = {
    Name = "Respawn",
    TweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quint, Enum.EasingDirection.Out),
}

local Theme = {
    -- Base Colors
    Window      = Color3.fromRGB(10, 10, 10),       -- Almost Pure Black
    Sidebar     = Color3.fromRGB(5, 5, 5),          -- Pure Black
    Section     = Color3.fromRGB(18, 18, 18),       -- Dark container background
    
    -- Topbar Specifics
    Topbar      = Color3.fromRGB(15, 15, 15),       -- Slightly lighter black
    TopbarLine  = Color3.fromRGB(80, 80, 80),       -- Separator line
    
    -- Accents & States
    Accent      = Color3.fromRGB(192, 192, 192),    -- Silver (c0c0c0)
    Outline     = Color3.fromRGB(45, 45, 45),       -- Subtle outline
    Hover       = Color3.fromRGB(30, 30, 30),       -- Hover state
    
    -- Text
    Text        = Color3.fromRGB(240, 240, 240),    -- White
    TextDim     = Color3.fromRGB(140, 140, 140),    -- Grey
    
    -- Status
    Success     = Color3.fromRGB(100, 255, 100),
    Warning     = Color3.fromRGB(255, 200, 50),
    Error       = Color3.fromRGB(255, 80, 80),
}

--// 3.0 UTILITY LIBRARY
local Utility = {}

function Utility.Create(class, properties, children)
    local inst = Instance.new(class)
    for k, v in pairs(properties or {}) do inst[k] = v end
    for _, child in ipairs(children or {}) do child.Parent = inst end
    return inst
end

function Utility.Tween(inst, props)
    TweenService:Create(inst, Config.TweenInfo, props):Play()
end

-- [ ICON LOADER ] --
function Utility.GetIcon(iconName)
    -- If it's a URL or Asset ID, return as is
    if string.find(iconName, "rbxassetid://") or string.find(iconName, "http") then
        return iconName
    end
    
    -- Check if executor supports file system
    if not makefolder or not writefile or not getcustomasset then
        warn("[Respawn] Executor does not support file system. Icons may fail.")
        return "rbxassetid://0"
    end

    local fileName = iconName .. ".png"
    local folderPath = "RespawnIcons"
    local filePath = folderPath .. "/" .. fileName
    local githubUrl = "https://raw.githubusercontent.com/latte-soft/lucide-roblox/master/icons/compiled/48px/" .. fileName
    
    if not isfolder(folderPath) then makefolder(folderPath) end
    
    if not isfile(filePath) then
        local success, response = pcall(function() return game:HttpGet(githubUrl) end)
        if success then
            writefile(filePath, response)
        else
            warn("[Respawn] Failed to fetch icon: " .. iconName)
            return "rbxassetid://0"
        end
    end
    
    return getcustomasset(filePath)
end

function Utility.Drag(frame, handle)
    local dragging, dragInput, dragStart, startPos
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            Utility.Tween(frame, {Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)})
        end
    end)
end

--// 4.0 GLOBAL STATE
local State = { Window = nil, Container = nil, Sidebar = nil, ActiveTab = nil, NotifyList = nil }

--// 5.0 COMPONENT FACTORY
local TabClass = {}
TabClass.__index = TabClass

-- [ TAB ] --
function Respawn:AddTab(name, iconName)
    local tab = {Name = name, Elements = {}}
    
    local btn = Utility.Create("TextButton", {
        Parent = State.Sidebar, Size = UDim2.new(1, 0, 0, 45),
        BackgroundTransparency = 1, Text = "", AutoButtonColor = false
    })
    
    -- Icon Logic
    local targetIcon = iconName and Utility.GetIcon(iconName) or "rbxassetid://10709762956"
    local iconImg = Utility.Create("ImageLabel", {
        Parent = btn, BackgroundTransparency = 1,
        Size = UDim2.new(0, 24, 0, 24), Position = UDim2.new(0.5, -12, 0.5, -12),
        Image = targetIcon, ImageColor3 = Theme.TextDim
    })
    
    local indicator = Utility.Create("Frame", {
        Parent = btn, Size = UDim2.new(0, 3, 0.6, 0),
        Position = UDim2.new(0, 0, 0.2, 0), BackgroundColor3 = Theme.Accent,
        BackgroundTransparency = 1
    })

    local page = Utility.Create("ScrollingFrame", {
        Parent = State.Container, Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1, Visible = false, ScrollBarThickness = 2,
        ScrollBarImageColor3 = Theme.Accent, CanvasSize = UDim2.new(0,0,0,0)
    })
    Utility.Create("UIPadding", {Parent = page, PaddingTop = UDim.new(0, 15), PaddingLeft = UDim.new(0, 15), PaddingRight = UDim.new(0, 15)})
    local layout = Utility.Create("UIListLayout", {Parent = page, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 8)})
    
    layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        page.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 20)
    end)

    btn.Activated:Connect(function()
        if State.ActiveTab then
            State.ActiveTab.Page.Visible = false
            Utility.Tween(State.ActiveTab.Icon, {ImageColor3 = Theme.TextDim})
            Utility.Tween(State.ActiveTab.Ind, {BackgroundTransparency = 1})
        end
        State.ActiveTab = {Page = page, Icon = iconImg, Ind = indicator}
        page.Visible = true
        page.Position = UDim2.new(0, 0, 0.05, 0)
        Utility.Tween(page, {Position = UDim2.new(0,0,0,0)})
        Utility.Tween(iconImg, {ImageColor3 = Theme.Accent})
        Utility.Tween(indicator, {BackgroundTransparency = 0})
    end)
    
    setmetatable(tab, TabClass)
    tab.Container = page
    return tab
end

-- [ SECTION ] --
function TabClass:AddSection(text)
    local frame = Utility.Create("Frame", {
        Parent = self.Container, Size = UDim2.new(1, 0, 0, 30), BackgroundTransparency = 1
    })
    Utility.Create("TextLabel", {
        Parent = frame, Text = text:upper(), TextSize = 11,
        TextColor3 = Theme.Accent, Font = Enum.Font.GothamBold,
        BackgroundTransparency = 1, Size = UDim2.new(1, 0, 1, 0),
        TextXAlignment = Enum.TextXAlignment.Left, Position = UDim2.new(0, 2, 0, 0)
    })
end

-- [ BUTTON ] --
function TabClass:AddButton(text, callback)
    local container = Utility.Create("Frame", {
        Parent = self.Container, Size = UDim2.new(1, 0, 0, 35), BackgroundTransparency = 1
    })
    local btn = Utility.Create("TextButton", {
        Parent = container, Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = Theme.Section, Text = text,
        TextColor3 = Theme.Text, Font = Enum.Font.Gotham,
        TextSize = 14, AutoButtonColor = false
    })
    Utility.Create("UICorner", {Parent = btn, CornerRadius = UDim.new(0, 4)})
    Utility.Create("UIStroke", {Parent = btn, Color = Theme.Outline, Thickness = 1, ApplyStrokeMode = Enum.ApplyStrokeMode.Border, Transparency = 0.6})

    btn.MouseEnter:Connect(function() Utility.Tween(btn, {BackgroundColor3 = Theme.Hover}) end)
    btn.MouseLeave:Connect(function() Utility.Tween(btn, {BackgroundColor3 = Theme.Section}) end)
    btn.Activated:Connect(function()
        if callback then callback() end
        Utility.Tween(btn, {TextSize = 12})
        task.wait(0.1)
        Utility.Tween(btn, {TextSize = 14})
    end)
end

-- [ TOGGLE ] --
function TabClass:AddToggle(text, default, callback)
    local state = default or false
    local container = Utility.Create("Frame", {
        Parent = self.Container, Size = UDim2.new(1, 0, 0, 35),
        BackgroundColor3 = Theme.Section
    })
    Utility.Create("UICorner", {Parent = container, CornerRadius = UDim.new(0, 4)})
    Utility.Create("UIStroke", {Parent = container, Color = Theme.Outline, Thickness = 1, Transparency = 0.6})
    
    local label = Utility.Create("TextLabel", {
        Parent = container, Text = text, TextColor3 = Theme.Text,
        Font = Enum.Font.Gotham, TextSize = 14, BackgroundTransparency = 1,
        Size = UDim2.new(0.7, 0, 1, 0), Position = UDim2.new(0, 10, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local box = Utility.Create("Frame", {
        Parent = container, Size = UDim2.new(0, 20, 0, 20),
        Position = UDim2.new(1, -30, 0.5, -10), BackgroundColor3 = state and Theme.Accent or Theme.Window,
        BorderSizePixel = 0
    })
    Utility.Create("UICorner", {Parent = box, CornerRadius = UDim.new(0, 4)})
    
    local btn = Utility.Create("TextButton", {
        Parent = container, Size = UDim2.new(1, 0, 1, 0), BackgroundTransparency = 1, Text = ""
    })
    
    btn.Activated:Connect(function()
        state = not state
        Utility.Tween(box, {BackgroundColor3 = state and Theme.Accent or Theme.Window})
        if callback then callback(state) end
    end)
end

-- [ SLIDER ] --
function TabClass:AddSlider(text, options, callback)
    local min, max, default = options.Min, options.Max, options.Default
    local value = default
    
    local container = Utility.Create("Frame", {
        Parent = self.Container, Size = UDim2.new(1, 0, 0, 50),
        BackgroundColor3 = Theme.Section
    })
    Utility.Create("UICorner", {Parent = container, CornerRadius = UDim.new(0, 4)})
    Utility.Create("UIStroke", {Parent = container, Color = Theme.Outline, Thickness = 1, Transparency = 0.6})

    Utility.Create("TextLabel", {
        Parent = container, Text = text, TextColor3 = Theme.Text,
        Font = Enum.Font.Gotham, TextSize = 14, BackgroundTransparency = 1,
        Size = UDim2.new(1, -20, 0, 20), Position = UDim2.new(0, 10, 0, 5),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local valLabel = Utility.Create("TextLabel", {
        Parent = container, Text = tostring(default), TextColor3 = Theme.TextDim,
        Font = Enum.Font.Gotham, TextSize = 14, BackgroundTransparency = 1,
        Size = UDim2.new(0, 50, 0, 20), Position = UDim2.new(1, -60, 0, 5),
        TextXAlignment = Enum.TextXAlignment.Right
    })
    
    local slideBg = Utility.Create("Frame", {
        Parent = container, Size = UDim2.new(1, -20, 0, 4),
        Position = UDim2.new(0, 10, 0, 35), BackgroundColor3 = Theme.Window
    })
    Utility.Create("UICorner", {Parent = slideBg, CornerRadius = UDim.new(1, 0)})
    
    local fill = Utility.Create("Frame", {
        Parent = slideBg, Size = UDim2.new((default - min)/(max - min), 0, 1, 0),
        BackgroundColor3 = Theme.Accent, BorderSizePixel = 0
    })
    Utility.Create("UICorner", {Parent = fill, CornerRadius = UDim.new(1, 0)})
    
    local trigger = Utility.Create("TextButton", {
        Parent = slideBg, Size = UDim2.new(1, 0, 5, 0), Position = UDim2.new(0, 0, -2, 0),
        BackgroundTransparency = 1, Text = ""
    })
    
    local dragging = false
    trigger.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true end end)
    UserInputService.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement) then
            local sizeX = slideBg.AbsoluteSize.X
            local mousePos = input.Position.X - slideBg.AbsolutePosition.X
            local percent = math.clamp(mousePos / sizeX, 0, 1)
            value = math.floor(min + (max - min) * percent)
            fill.Size = UDim2.new(percent, 0, 1, 0)
            valLabel.Text = tostring(value)
            if callback then callback(value) end
        end
    end)
end

-- [ DROPDOWN ] --
function TabClass:AddDropdown(text, items, callback)
    local isOpen = false
    local current = items[1] or "Select"
    
    local container = Utility.Create("Frame", {
        Parent = self.Container, Size = UDim2.new(1, 0, 0, 35),
        BackgroundColor3 = Theme.Section, ZIndex = 2
    })
    Utility.Create("UICorner", {Parent = container, CornerRadius = UDim.new(0, 4)})
    Utility.Create("UIStroke", {Parent = container, Color = Theme.Outline, Thickness = 1, Transparency = 0.6})
    
    Utility.Create("TextLabel", {
        Parent = container, Text = text, TextColor3 = Theme.Text,
        Font = Enum.Font.Gotham, TextSize = 14, BackgroundTransparency = 1,
        Size = UDim2.new(0.5, 0, 1, 0), Position = UDim2.new(0, 10, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local display = Utility.Create("TextLabel", {
        Parent = container, Text = current .. " ▼", TextColor3 = Theme.TextDim,
        Font = Enum.Font.Gotham, TextSize = 13, BackgroundTransparency = 1,
        Size = UDim2.new(0.5, -20, 1, 0), Position = UDim2.new(0.5, 10, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Right
    })
    
    local btn = Utility.Create("TextButton", {
        Parent = container, Size = UDim2.new(1, 0, 1, 0), BackgroundTransparency = 1, Text = ""
    })
    
    local list = Utility.Create("ScrollingFrame", {
        Parent = container, Size = UDim2.new(1, 0, 0, 0),
        Position = UDim2.new(0, 0, 1, 5), BackgroundColor3 = Theme.Section,
        BorderSizePixel = 0, Visible = false, ZIndex = 10, CanvasSize = UDim2.new(0,0,0,0),
        ScrollBarThickness = 2, ScrollBarImageColor3 = Theme.Accent
    })
    Utility.Create("UIStroke", {Parent = list, Color = Theme.Outline, Thickness = 1})
    Utility.Create("UIListLayout", {Parent = list, SortOrder = Enum.SortOrder.LayoutOrder})
    
    btn.Activated:Connect(function()
        isOpen = not isOpen
        list.Visible = isOpen
        display.Text = current .. (isOpen and " ▲" or " ▼")
        
        if isOpen then
            list:ClearAllChildren()
            local layout = Utility.Create("UIListLayout", {Parent = list, SortOrder = Enum.SortOrder.LayoutOrder})
            
            for _, item in ipairs(items) do
                local itemBtn = Utility.Create("TextButton", {
                    Parent = list, Size = UDim2.new(1, 0, 0, 30),
                    BackgroundTransparency = 1, Text = item,
                    TextColor3 = (item == current) and Theme.Accent or Theme.Text,
                    Font = Enum.Font.Gotham, TextSize = 13, ZIndex = 11
                })
                itemBtn.Activated:Connect(function()
                    current = item
                    display.Text = current .. " ▼"
                    if callback then callback(item) end
                    isOpen = false
                    list.Visible = false
                    list.Size = UDim2.new(1, 0, 0, 0)
                end)
            end
            local h = math.min(#items * 30, 150)
            list.Size = UDim2.new(1, 0, 0, h)
            list.CanvasSize = UDim2.new(0, 0, 0, #items * 30)
        else
            list.Size = UDim2.new(1, 0, 0, 0)
        end
    end)
end

--// 6.0 INITIALIZER & NOTIFICATIONS
function Respawn:Notify(opts)
    local notif = Utility.Create("Frame", {
        Parent = State.NotifyList, Size = UDim2.new(1, 0, 0, 60),
        BackgroundColor3 = Theme.Section, BackgroundTransparency = 0.1
    })
    Utility.Create("UICorner", {Parent = notif, CornerRadius = UDim.new(0, 4)})
    Utility.Create("UIStroke", {Parent = notif, Color = Theme.Outline, Transparency = 0.5})
    
    local bar = Utility.Create("Frame", {
        Parent = notif, Size = UDim2.new(0, 4, 1, 0),
        BackgroundColor3 = opts.Type == "Error" and Theme.Error or (opts.Type == "Warning" and Theme.Warning or Theme.Accent)
    })
    Utility.Create("UICorner", {Parent = bar, CornerRadius = UDim.new(0, 4)})
    
    Utility.Create("TextLabel", {
        Parent = notif, Text = opts.Title or "Notification", TextColor3 = Theme.Text,
        Font = Enum.Font.GothamBold, TextSize = 14, BackgroundTransparency = 1,
        Position = UDim2.new(0, 15, 0, 10), Size = UDim2.new(1, -20, 0, 20),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    Utility.Create("TextLabel", {
        Parent = notif, Text = opts.Text or "...", TextColor3 = Theme.TextDim,
        Font = Enum.Font.Gotham, TextSize = 12, BackgroundTransparency = 1,
        Position = UDim2.new(0, 15, 0, 30), Size = UDim2.new(1, -20, 0, 20),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    notif.Position = UDim2.new(1, 0, 0, 0)
    Utility.Tween(notif, {Position = UDim2.new(0, 0, 0, 0)})
    
    task.delay(opts.Duration or 3, function()
        Utility.Tween(notif, {Position = UDim2.new(1.2, 0, 0, 0)})
        task.wait(0.5)
        notif:Destroy()
    end)
end

function Respawn.init(playerGui)
    if State.Window then return end
    
    local gui = Utility.Create("ScreenGui", {Parent = playerGui, Name = "RespawnUI", ResetOnSpawn = false, ZIndexBehavior = Enum.ZIndexBehavior.Sibling})
    
    local win = Utility.Create("Frame", {
        Parent = gui, Size = UDim2.fromOffset(600, 400),
        Position = UDim2.fromScale(0.5, 0.5), AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = Theme.Window, BorderSizePixel = 0
    })
    Utility.Create("UICorner", {Parent = win, CornerRadius = UDim.new(0, 6)})
    
    -- Silver Glow
    Utility.Create("UIStroke", {Parent = win, Color = Theme.Accent, Transparency = 0.8, Thickness = 1})
    
    -- Shadow
    Utility.Create("ImageLabel", {
        Parent = win, Image = "rbxassetid://6015897843", ImageColor3 = Color3.new(0,0,0),
        ImageTransparency = 0.2, Size = UDim2.new(1, 50, 1, 50), Position = UDim2.new(0, -25, 0, -25),
        BackgroundTransparency = 1, ScaleType = Enum.ScaleType.Slice, SliceCenter = Rect.new(49,49,450,450), ZIndex = -1
    })

    -- DISTINCT TOPBAR
    local top = Utility.Create("Frame", {
        Parent = win, Size = UDim2.new(1, 0, 0, 40), 
        BackgroundColor3 = Theme.Topbar, BorderSizePixel = 0
    })
    Utility.Create("UICorner", {Parent = top, CornerRadius = UDim.new(0, 6)})
    
    -- Bottom Straightener for Topbar (hides bottom corners)
    local topStraight = Utility.Create("Frame", {
        Parent = top, Size = UDim2.new(1, 0, 0, 10), Position = UDim2.new(0, 0, 1, -10),
        BackgroundColor3 = Theme.Topbar, BorderSizePixel = 0
    })

    -- Divider Line
    Utility.Create("Frame", {
        Parent = top, Size = UDim2.new(1, 0, 0, 1), Position = UDim2.new(0, 0, 1, 0),
        BackgroundColor3 = Theme.TopbarLine, BackgroundTransparency = 0, BorderSizePixel = 0
    })

    Utility.Create("TextLabel", {
        Parent = top, Text = "RESPAWN // TITAN", TextColor3 = Theme.Accent,
        Font = Enum.Font.GothamBold, TextSize = 14, BackgroundTransparency = 1,
        Size = UDim2.new(0.5, 0, 1, 0), Position = UDim2.new(0, 15, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    Utility.Drag(win, top)
    
    local close = Utility.Create("TextButton", {
        Parent = top, Text = "×", TextColor3 = Theme.Text, TextSize = 24,
        Font = Enum.Font.Gotham, BackgroundTransparency = 1,
        Size = UDim2.new(0, 40, 1, 0), Position = UDim2.new(1, -40, 0, 0)
    })
    close.Activated:Connect(function() gui:Destroy() end)
    
    local sidebar = Utility.Create("ScrollingFrame", {
        Parent = win, Size = UDim2.new(0, 60, 1, -41), Position = UDim2.new(0, 0, 0, 41),
        BackgroundColor3 = Theme.Sidebar, BorderSizePixel = 0, ScrollBarThickness = 0
    })
    Utility.Create("UICorner", {Parent = sidebar, CornerRadius = UDim.new(0, 6)})
    Utility.Create("UIListLayout", {Parent = sidebar, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 5)})
    Utility.Create("UIPadding", {Parent = sidebar, PaddingTop = UDim.new(0, 10)})
    
    local content = Utility.Create("Frame", {
        Parent = win, Size = UDim2.new(1, -60, 1, -41), Position = UDim2.new(0, 60, 0, 41),
        BackgroundTransparency = 1
    })
    
    local notify = Utility.Create("Frame", {
        Parent = gui, Size = UDim2.new(0, 250, 1, 0), Position = UDim2.new(1, -260, 0, 20),
        BackgroundTransparency = 1
    })
    Utility.Create("UIListLayout", {Parent = notify, SortOrder = Enum.SortOrder.LayoutOrder, VerticalAlignment = Enum.VerticalAlignment.Bottom, Padding = UDim.new(0, 5)})
    
    State.Window = win
    State.Sidebar = sidebar
    State.Container = content
    State.NotifyList = notify
    
    return Respawn
end

return Respawn