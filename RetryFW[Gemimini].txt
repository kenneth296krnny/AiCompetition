--[[
    PROJECT: RESPAWN (v5.5 - MECHANIC FIX)
    Status: DRAGGABLE + TABS FIXED
    
    Fixes:
    1. Dragging: Re-implemented using Delta math and InputChanged.
    2. Tabs: Removed auto-select (starts blank).
    3. Sidebar: Fixed layout so buttons actually appear.
]]

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local Respawn = {}
Respawn.__index = Respawn

--// 1.0 CONFIGURATION
local Config = {
    Folder = "RespawnCache",
    TweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
}

local Theme = {
    Window      = Color3.fromRGB(18, 18, 18),
    Sidebar     = Color3.fromRGB(12, 12, 12),
    Topbar      = Color3.fromRGB(15, 15, 15),
    Lines       = Color3.fromRGB(40, 40, 40),
    Accent      = Color3.fromRGB(0, 122, 204),
    Text        = Color3.fromRGB(240, 240, 240),
    TextDim     = Color3.fromRGB(140, 140, 140),
    Hover       = Color3.fromRGB(25, 25, 25),
    Section     = Color3.fromRGB(22, 22, 22),
}

--// 2.0 UTILITY
local Utility = {}

function Utility.Create(class, props, children)
    local inst = Instance.new(class)
    for k, v in pairs(props or {}) do inst[k] = v end
    for _, child in ipairs(children or {}) do child.Parent = inst end
    return inst
end

function Utility.Tween(inst, props)
    TweenService:Create(inst, Config.TweenInfo, props):Play()
end

-- [ FIXED DRAG SYSTEM ] --
function Utility.Drag(frame, handle)
    local dragging, dragInput, dragStart, startPos
    
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            local newPos = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + delta.X,
                startPos.Y.Scale, startPos.Y.Offset + delta.Y
            )
            -- Use Tween for smoother dragging, or set directly for instant
            TweenService:Create(frame, TweenInfo.new(0.05), {Position = newPos}):Play()
        end
    end)
end

function Utility.GetIcon(name)
    if not name then return "" end
    if string.find(name, "rbxassetid") then return name end
    
    -- Executor Check
    if not makefolder or not writefile then return "rbxassetid://0" end
    
    local fileName = name .. ".png"
    local path = Config.Folder .. "/" .. fileName
    local url = "https://raw.githubusercontent.com/latte-soft/lucide-roblox/master/icons/compiled/48px/" .. fileName
    
    if not isfolder(Config.Folder) then makefolder(Config.Folder) end
    if not isfile(path) then
        local success, response = pcall(function() return game:HttpGet(url) end)
        if success then writefile(path, response) end
    end
    return getcustomasset(path)
end

--// 3.0 GLOBAL STATE
local UI = {
    Window = nil,
    Sidebar = nil,
    Container = nil,
    NotifyList = nil,
    ActiveTab = nil
}

--// 4.0 INITIALIZER
function Respawn.init(targetGui)
    -- Cleanup old instances
    if targetGui:FindFirstChild("RespawnUI_v5") then
        targetGui.RespawnUI_v5:Destroy()
    end

    local gui = Utility.Create("ScreenGui", {
        Parent = targetGui, 
        Name = "RespawnUI_v5", 
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })

    -- Main Window
    local win = Utility.Create("Frame", {
        Parent = gui, Size = UDim2.fromOffset(600, 380),
        Position = UDim2.fromScale(0.5, 0.5), AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = Theme.Window, BorderSizePixel = 0
    })
    Utility.Create("UICorner", {Parent = win, CornerRadius = UDim.new(0, 6)})
    Utility.Create("UIStroke", {Parent = win, Color = Theme.Lines, Thickness = 1})

    -- Topbar (Drag Handle)
    local top = Utility.Create("Frame", {
        Parent = win, Size = UDim2.new(1, 0, 0, 40),
        BackgroundColor3 = Theme.Topbar, BorderSizePixel = 0,
        Active = true -- CRITICAL FOR DRAGGING
    })
    Utility.Create("UICorner", {Parent = top, CornerRadius = UDim.new(0, 6)})
    Utility.Create("Frame", { -- Hide bottom corners
        Parent = top, Size = UDim2.new(1, 0, 0, 10), Position = UDim2.new(0,0,1,-10),
        BackgroundColor3 = Theme.Topbar, BorderSizePixel = 0
    })
    
    Utility.Create("TextLabel", {
        Parent = top, Text = "RESPAWN // ENGINE", TextColor3 = Theme.Text,
        Font = Enum.Font.GothamBold, TextSize = 14, BackgroundTransparency = 1,
        Size = UDim2.new(0.5, 0, 1, 0), Position = UDim2.new(0, 15, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    -- Initialize Drag
    Utility.Drag(win, top)

    -- Sidebar
    local sidebar = Utility.Create("ScrollingFrame", {
        Parent = win, Size = UDim2.new(0, 150, 1, -41), Position = UDim2.new(0, 0, 0, 41),
        BackgroundColor3 = Theme.Sidebar, BorderSizePixel = 0,
        ScrollBarThickness = 2, CanvasSize = UDim2.new(0,0,0,0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y -- IMPORTANT FOR TABS
    })
    Utility.Create("UICorner", {Parent = sidebar, CornerRadius = UDim.new(0, 6)})
    Utility.Create("Frame", { -- Hide corners
        Parent = sidebar, Size = UDim2.new(0, 10, 1, 0), Position = UDim2.new(1,-10,0,0),
        BackgroundColor3 = Theme.Sidebar, BorderSizePixel = 0
    })
    Utility.Create("UIListLayout", {Parent = sidebar, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 5)})
    Utility.Create("UIPadding", {Parent = sidebar, PaddingTop = UDim.new(0, 10), PaddingLeft = UDim.new(0, 10), PaddingRight = UDim.new(0, 10)})

    -- Vertical Divider
    Utility.Create("Frame", {
        Parent = win, Size = UDim2.new(0, 1, 1, -41), Position = UDim2.new(0, 150, 0, 41),
        BackgroundColor3 = Theme.Lines, BorderSizePixel = 0
    })

    -- Page Container
    local container = Utility.Create("Frame", {
        Parent = win, Size = UDim2.new(1, -151, 1, -41), Position = UDim2.new(0, 151, 0, 41),
        BackgroundTransparency = 1, ClipsDescendants = true
    })

    -- Notify Container
    local notify = Utility.Create("Frame", {
        Parent = gui, Size = UDim2.new(0, 250, 1, 0), Position = UDim2.new(1, -260, 0, 20),
        BackgroundTransparency = 1
    })
    Utility.Create("UIListLayout", {Parent = notify, SortOrder = Enum.SortOrder.LayoutOrder, VerticalAlignment = Enum.VerticalAlignment.Bottom, Padding = UDim.new(0, 5)})

    UI.Window = win
    UI.Sidebar = sidebar
    UI.Container = container
    UI.NotifyList = notify

    return Respawn
end

--// 5.0 COMPONENTS
local Tab = {}
Tab.__index = Tab

function Respawn:AddTab(name, iconName)
    local tabObj = {}
    
    -- 1. Create Button
    local btn = Utility.Create("TextButton", {
        Parent = UI.Sidebar, Size = UDim2.new(1, 0, 0, 35),
        BackgroundColor3 = Theme.Sidebar, AutoButtonColor = false,
        Text = ""
    })
    Utility.Create("UICorner", {Parent = btn, CornerRadius = UDim.new(0, 6)})
    
    local icon = Utility.Create("ImageLabel", {
        Parent = btn, Size = UDim2.new(0, 20, 0, 20), Position = UDim2.new(0, 10, 0.5, -10),
        BackgroundTransparency = 1, Image = Utility.GetIcon(iconName),
        ImageColor3 = Theme.TextDim
    })
    
    local label = Utility.Create("TextLabel", {
        Parent = btn, Size = UDim2.new(1, -40, 1, 0), Position = UDim2.new(0, 38, 0, 0),
        BackgroundTransparency = 1, Text = name, TextColor3 = Theme.TextDim,
        Font = Enum.Font.GothamMedium, TextSize = 13, TextXAlignment = Enum.TextXAlignment.Left
    })
    
    -- 2. Create Page (Hidden by Default)
    local page = Utility.Create("ScrollingFrame", {
        Parent = UI.Container, Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1, Visible = false, -- STARTS HIDDEN
        ScrollBarThickness = 2, BorderSizePixel = 0,
        AutomaticCanvasSize = Enum.AutomaticSize.Y
    })
    Utility.Create("UIPadding", {Parent = page, PaddingTop = UDim.new(0, 15), PaddingLeft = UDim.new(0, 15), PaddingRight = UDim.new(0, 15), PaddingBottom = UDim.new(0, 15)})
    Utility.Create("UIListLayout", {Parent = page, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 8)})

    -- 3. Click Logic
    btn.Activated:Connect(function()
        -- Deactivate current
        if UI.ActiveTab then
            UI.ActiveTab.Page.Visible = false
            Utility.Tween(UI.ActiveTab.Btn, {BackgroundColor3 = Theme.Sidebar})
            Utility.Tween(UI.ActiveTab.Txt, {TextColor3 = Theme.TextDim})
            Utility.Tween(UI.ActiveTab.Img, {ImageColor3 = Theme.TextDim})
        end
        
        -- Activate this
        UI.ActiveTab = {Page = page, Btn = btn, Txt = label, Img = icon}
        page.Visible = true
        Utility.Tween(btn, {BackgroundColor3 = Theme.Section})
        Utility.Tween(label, {TextColor3 = Theme.Text})
        Utility.Tween(icon, {ImageColor3 = Theme.Accent})
    end)
    
    setmetatable(tabObj, Tab)
    tabObj.Container = page
    return tabObj
end

-- [ SECTION ]
function Tab:AddSection(text)
    local holder = Utility.Create("Frame", {
        Parent = self.Container, Size = UDim2.new(1, 0, 0, 30), BackgroundTransparency = 1
    })
    Utility.Create("TextLabel", {
        Parent = holder, Text = text, TextColor3 = Theme.Accent,
        Font = Enum.Font.GothamBold, TextSize = 12, BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0), TextXAlignment = Enum.TextXAlignment.Left,
        TextYAlignment = Enum.TextYAlignment.Bottom
    })
end

-- [ BUTTON ]
function Tab:AddButton(text, callback)
    local btn = Utility.Create("TextButton", {
        Parent = self.Container, Size = UDim2.new(1, 0, 0, 32),
        BackgroundColor3 = Theme.Section, Text = text,
        TextColor3 = Theme.Text, Font = Enum.Font.Gotham, TextSize = 13,
        AutoButtonColor = false
    })
    Utility.Create("UICorner", {Parent = btn, CornerRadius = UDim.new(0, 4)})
    Utility.Create("UIStroke", {Parent = btn, Color = Theme.Lines, Thickness = 1})
    
    btn.MouseEnter:Connect(function() Utility.Tween(btn, {BackgroundColor3 = Theme.Hover}) end)
    btn.MouseLeave:Connect(function() Utility.Tween(btn, {BackgroundColor3 = Theme.Section}) end)
    btn.Activated:Connect(function()
        if callback then callback() end
        Utility.Tween(btn, {TextSize = 11})
        task.wait(0.1)
        Utility.Tween(btn, {TextSize = 13})
    end)
end

-- [ TOGGLE ]
function Tab:AddToggle(text, default, callback)
    local state = default or false
    local btn = Utility.Create("TextButton", {
        Parent = self.Container, Size = UDim2.new(1, 0, 0, 32),
        BackgroundColor3 = Theme.Section, AutoButtonColor = false, Text = ""
    })
    Utility.Create("UICorner", {Parent = btn, CornerRadius = UDim.new(0, 4)})
    Utility.Create("UIStroke", {Parent = btn, Color = Theme.Lines, Thickness = 1})
    
    Utility.Create("TextLabel", {
        Parent = btn, Text = text, TextColor3 = Theme.Text,
        Font = Enum.Font.Gotham, TextSize = 13, BackgroundTransparency = 1,
        Size = UDim2.new(1, -30, 1, 0), Position = UDim2.new(0, 10, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local indicator = Utility.Create("Frame", {
        Parent = btn, Size = UDim2.new(0, 16, 0, 16),
        Position = UDim2.new(1, -26, 0.5, -8), BackgroundColor3 = state and Theme.Accent or Theme.Window
    })
    Utility.Create("UICorner", {Parent = indicator, CornerRadius = UDim.new(0, 4)})
    
    btn.Activated:Connect(function()
        state = not state
        Utility.Tween(indicator, {BackgroundColor3 = state and Theme.Accent or Theme.Window})
        if callback then callback(state) end
    end)
end

-- [ SLIDER ]
function Tab:AddSlider(text, options, callback)
    local min, max, val = options.Min, options.Max, options.Default
    
    local box = Utility.Create("Frame", {
        Parent = self.Container, Size = UDim2.new(1, 0, 0, 50),
        BackgroundColor3 = Theme.Section
    })
    Utility.Create("UICorner", {Parent = box, CornerRadius = UDim.new(0, 4)})
    Utility.Create("UIStroke", {Parent = box, Color = Theme.Lines, Thickness = 1})
    
    Utility.Create("TextLabel", {
        Parent = box, Text = text, TextColor3 = Theme.Text,
        Font = Enum.Font.Gotham, TextSize = 13, BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 25), Position = UDim2.new(0, 10, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local num = Utility.Create("TextLabel", {
        Parent = box, Text = tostring(val), TextColor3 = Theme.TextDim,
        Font = Enum.Font.Gotham, TextSize = 13, BackgroundTransparency = 1,
        Size = UDim2.new(0, 50, 0, 25), Position = UDim2.new(1, -60, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Right
    })
    
    local bar = Utility.Create("Frame", {
        Parent = box, Size = UDim2.new(1, -20, 0, 4), Position = UDim2.new(0, 10, 0, 35),
        BackgroundColor3 = Theme.Window
    })
    Utility.Create("UICorner", {Parent = bar, CornerRadius = UDim.new(1, 0)})
    
    local fill = Utility.Create("Frame", {
        Parent = bar, Size = UDim2.new((val-min)/(max-min), 0, 1, 0),
        BackgroundColor3 = Theme.Accent
    })
    Utility.Create("UICorner", {Parent = fill, CornerRadius = UDim.new(1, 0)})
    
    local trigger = Utility.Create("TextButton", {
        Parent = bar, Size = UDim2.new(1, 0, 5, 0), Position = UDim2.new(0,0,-2,0),
        BackgroundTransparency = 1, Text = ""
    })
    
    local dragging = false
    trigger.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true end end)
    UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
    UserInputService.InputChanged:Connect(function(i)
        if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
            local p = math.clamp((i.Position.X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X, 0, 1)
            val = math.floor(min + ((max-min) * p))
            fill.Size = UDim2.new(p, 0, 1, 0)
            num.Text = tostring(val)
            if callback then callback(val) end
        end
    end)
end

-- [ NOTIFY ]
function Respawn:Notify(opts)
    local box = Utility.Create("Frame", {
        Parent = UI.NotifyList, Size = UDim2.new(1, 0, 0, 0), AutomaticSize = Enum.AutomaticSize.Y,
        BackgroundColor3 = Theme.Section, BackgroundTransparency = 0.1
    })
    Utility.Create("UICorner", {Parent = box, CornerRadius = UDim.new(0, 4)})
    Utility.Create("UIStroke", {Parent = box, Color = Theme.Lines, Thickness = 1})
    Utility.Create("UIPadding", {Parent = box, PaddingTop = UDim.new(0,10), PaddingBottom = UDim.new(0,10), PaddingLeft = UDim.new(0,10)})
    
    local title = Utility.Create("TextLabel", {
        Parent = box, Text = opts.Title or "Alert", TextColor3 = Theme.Text,
        Font = Enum.Font.GothamBold, TextSize = 14, BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 15), TextXAlignment = Enum.TextXAlignment.Left
    })
    
    Utility.Create("TextLabel", {
        Parent = box, Text = opts.Text or "Info", TextColor3 = Theme.TextDim,
        Font = Enum.Font.Gotham, TextSize = 12, BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 15), Position = UDim2.new(0,0,0,20),
        TextXAlignment = Enum.TextXAlignment.Left, TextWrapped = true
    })
    
    local bar = Utility.Create("Frame", {
        Parent = box, Size = UDim2.new(0, 3, 1, -10), Position = UDim2.new(0, -10, 0, 5),
        BackgroundColor3 = opts.Type == "Error" and Theme.Error or Theme.Accent
    })
    
    task.delay(opts.Duration or 3, function() box:Destroy() end)
end

return Respawn